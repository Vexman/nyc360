<div class="profile-page-container">

   <!-- 1. LOADING STATE -->
   <div *ngIf="isLoading" class="loading-center">
      <div class="loader-diamond"></div>
   </div>

   <div *ngIf="!isLoading && user" class="profile-wrapper">

      <!-- 2. HEADER SECTION -->
      <header class="profile-header-premium animate__animated animate__fadeIn">
         <div class="cover-photo" [style.backgroundImage]="'url(' + resolveCover(user.coverImageUrl) + ')'">
            <div class="cover-overlay"></div>
         </div>

         <div class="profile-meta-row">
            <div class="avatar-container">
               <div class="avatar-wrapper">
                  <img [src]="resolveImage(user.imageUrl)" alt="Profile">
               </div>
            </div>

            <div class="identity-block">
               <div class="name-status">
                  <h1>
                     {{ displayName }}
                     <i class="bi bi-patch-check-fill verified-icon" *ngIf="isVerified"
                        title="Verified Professional"></i>
                  </h1>
               </div>
               <p class="headline-text">{{ user.headline || 'Impactful Member @ NYC 360' }}</p>
               <div class="meta-badges">
                  <span class="meta-tag"><i class="bi bi-geo-alt"></i> {{ user.location || 'New York, USA' }}</span>
                  <!-- Show joined date only if we can derive it, or generic -->
                  <span class="meta-tag"><i class="bi bi-calendar3"></i> Active Member</span>
               </div>
            </div>

            <div class="header-actions">
               <!-- Edit Profile Removed -->
               <button *ngIf="!isOwner" class="btn-follow">
                  <i class="bi bi-person-plus-fill"></i> Follow
               </button>
            </div>
         </div>
      </header>

      <!-- 3. NAVIGATION -->
      <nav class="sticky-tabs">
         <div class="tabs-container">
            <button class="tab-item" [class.active]="activeTab === 'posts'" (click)="switchTab('posts')">
               <i class="bi bi-grid-3x3"></i> Timeline
            </button>
            <button class="tab-item" [class.active]="activeTab === 'about'" (click)="switchTab('about')">
               <i class="bi bi-person-badge"></i> About
            </button>
            <button class="tab-item" [class.active]="activeTab === 'saved'" (click)="switchTab('saved')"
               *ngIf="isOwner">
               <i class="bi bi-bookmark"></i> Saved
            </button>
         </div>
      </nav>

      <!-- 4. CONTENT GRID -->
      <div class="layout-grid" [ngSwitch]="activeTab">

         <!-- LEFT SIDEBAR -->
         <aside class="side-col">
            <div class="glass-card mb-4" *ngIf="user.bio || isOwner">
               <h4 class="section-title">About Me</h4>
               <p class="bio-text" *ngIf="user.bio">{{ user.bio }}</p>

            </div>



            <div class="glass-card mb-4" *ngIf="user.socialLinks.length">
               <h4 class="section-title">Connect</h4>
               <div class="social-links-grid">
                  <a *ngFor="let link of user.socialLinks" [href]="link.url" target="_blank" class="social-icon-btn"
                     [title]="getPlatformName(link.platform)">
                     <i class="bi" [ngClass]="getPlatformIcon(link.platform)"></i>
                  </a>
               </div>
            </div>


         </aside>

         <!-- MAIN FEED -->
         <main class="feed-col">

            <!-- Timeline Tab -->
            <div *ngSwitchCase="'posts'" class="animate__animated animate__fadeIn">
               <!-- Create Post Reminder (Owner Only) -->
               <div class="create-post-card glass-card" *ngIf="isOwner">
                  <div class="input-trigger" (click)="viewPostDetails('create', $event)">
                     <img [src]="resolveImage(user.imageUrl)" class="mini-avatar">
                     <span class="">Share an update with your city...</span>
                  </div>
                  <div class="action-bar">
                     <button (click)="viewPostDetails('create', $event)"><i class="bi bi-image text-success"></i>
                        Media</button>
                     <button (click)="viewPostDetails('create', $event)"><i
                           class="bi bi-calendar-event text-warning"></i> Event</button>
                     <button (click)="viewPostDetails('create', $event)"><i
                           class="bi bi-file-earmark-text text-primary"></i> Article</button>
                  </div>
               </div>

               <!-- Empty Case -->
               <div *ngIf="!user.recentPosts.length" class="empty-state">
                  <div class="icon-circle"><i class="bi bi-journals"></i></div>
                  <h3>No posts yet</h3>
                  <p>Shared updates and insights will appear here.</p>
               </div>

               <!-- Posts List -->
               <article *ngFor="let post of user.recentPosts"
                  class="post-card glass-card animate__animated animate__fadeInUp">
                  <div class="post-header">
                     <div class="user-info">
                        <img [src]="resolveImage(user.imageUrl)" class="post-avatar">
                        <div class="meta" (click)="viewPostDetails(post.id, $event)">
                           <h3>{{ displayName }}</h3>
                           <p>{{ post.createdAt | date:'longDate' }}</p>
                        </div>
                     </div>
                  </div>

                  <div class="post-body" (click)="viewPostDetails(post.id, $event)">
                     <h4 *ngIf="post.title" class="post-title">{{ post.title }}</h4>
                     <p class="post-content">{{ post.content }}</p>

                     <!-- Repost Content -->
                     <!-- Repost Content -->
                     <div *ngIf="post.parentPost" class="repost-box">
                        <div class="re-header">
                           <img [src]="getAuthorImage(post.parentPost.author)" class="re-avatar">
                           <strong>{{ getAuthorName(post.parentPost.author) }}</strong>
                        </div>
                        <h5>{{ post.parentPost.title }}</h5>
                        <p>{{ post.parentPost.content }}</p>

                        <!-- Shared Post Media -->
                        <div
                           *ngIf="(post.parentPost.attachments && post.parentPost.attachments.length > 0) || post.parentPost.imageUrl"
                           class="post-media-container mt-3">
                           <img *ngIf="post.parentPost.attachments && post.parentPost.attachments.length > 0"
                              [src]="resolveImageUrl(post.parentPost.attachments[0].url)" class="post-img">
                           <img
                              *ngIf="(!post.parentPost.attachments || post.parentPost.attachments.length === 0) && post.parentPost.imageUrl"
                              [src]="resolveImageUrl(post.parentPost.imageUrl)" class="post-img">
                        </div>
                     </div>

                     <!-- Media -->
                     <!-- Media -->
                     <div *ngIf="(post.attachments && post.attachments.length > 0) || post.imageUrl"
                        class="post-media-container">
                        <img *ngIf="post.attachments && post.attachments.length > 0"
                           [src]="resolveImageUrl(post.attachments[0].url)" class="post-img">
                        <img *ngIf="(!post.attachments || post.attachments.length === 0) && post.imageUrl"
                           [src]="resolveImageUrl(post.imageUrl)" class="post-img">
                     </div>
                  </div>

                  <!-- PRO INTERACTION BAR -->
                  <div class="interaction-card"
                     style="border:none; box-shadow:none; padding: 20px 0 0 0; margin: 0; margin-top: 15px; border-top: 1px solid #eee; border-radius: 0;">
                     <button class="btn-action-premium"
                        [class.active-like]="post.userInteraction === InteractionType.Like"
                        (click)="toggleInteraction(post, InteractionType.Like, $event)">
                        <i class="bi"
                           [ngClass]="post.userInteraction === InteractionType.Like ? 'bi-hand-thumbs-up-fill' : 'bi-hand-thumbs-up'"></i>
                        <span>{{ post.stats?.likes || 0 }}</span>
                     </button>

                     <button class="btn-action-premium"
                        [class.active-dislike]="post.userInteraction === InteractionType.Dislike"
                        (click)="toggleInteraction(post, InteractionType.Dislike, $event)">
                        <i class="bi"
                           [ngClass]="post.userInteraction === InteractionType.Dislike ? 'bi-hand-thumbs-down-fill' : 'bi-hand-thumbs-down'"></i>
                        <span>{{ post.stats?.dislikes || 0 }}</span>
                     </button>

                     <button class="btn-action-premium" (click)="toggleComments(post, $event)">
                        <i class="bi bi-chat-left-dots"></i>
                        <span>{{ post.stats?.comments || 0 }}</span>
                     </button>

                     <button class="share-btn-accent" (click)="openShareModal(post, $event)">
                        <i class="bi bi-share-fill"></i> SHARE
                     </button>
                  </div>

                  <!-- PRO COMMENTS SECTION -->
                  <section class="premium-comments animate__animated animate__fadeIn" *ngIf="post.showComments"
                     style="margin-top: 25px;">
                     <!-- Input -->
                     <div class="comment-entry" (click)="$event.stopPropagation()">
                        <input type="text" placeholder="Share your perspective..." [(ngModel)]="post.newCommentContent"
                           (keydown.enter)="submitComment(post, $event)">
                        <button class="btn-submit-comment" (click)="submitComment(post, $event)"
                           [disabled]="!((post.newCommentContent || '').trim())">
                           <i class="bi bi-arrow-right-short fs-2"></i>
                        </button>
                     </div>

                     <!-- Thread -->
                     <div class="comments-thread" (click)="$event.stopPropagation()">
                        <div class="comment-node" *ngFor="let comment of (post.comments || [])">
                           <div class="comment-card">
                              <div class="comment-content-box">
                                 <div class="header">
                                    <strong>{{ getAuthorName(comment.author) }}</strong>
                                    <time>{{ comment.createdAt | date:'shortTime' }}</time>
                                 </div>
                                 <div class="text">{{ comment.content }}</div>
                                 <div class="footer">
                                    <button class="btn-reply-text" (click)="openReplyInput(comment)">REPLY</button>
                                 </div>
                              </div>
                           </div>

                           <!-- Reply Input -->
                           <div class="comment-entry mt-3 mx-4" *ngIf="activeReplyId === comment.id">
                              <input #replyIn type="text" placeholder="Replying..."
                                 (keydown.enter)="submitReply(post, comment, replyIn.value)">
                              <button class="btn-submit-comment" (click)="submitReply(post, comment, replyIn.value)">
                                 <i class="bi bi-arrow-return-right"></i>
                              </button>
                           </div>

                           <!-- Replies -->
                           <div class="reply-indent" *ngIf="comment.replies?.length">
                              <div class="reply-node" *ngFor="let reply of comment.replies">
                                 <div class="comment-card">
                                    <div class="comment-content-box">
                                       <div class="header">
                                          <strong>{{ getAuthorName(reply.author) }}</strong>
                                          <time>{{ reply.createdAt | date:'shortTime' }}</time>
                                       </div>
                                       <div class="text">{{ reply.content }}</div>
                                    </div>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </section>
               </article>
            </div>

            <!-- About Tab -->
            <div *ngSwitchCase="'about'" class="animate__animated animate__fadeIn">
               <div class="glass-card mb-4">
                  <h3 class="section-title"><i class="bi bi-briefcase"></i> Work Experience</h3>
                  <div class="experience-list">
                     <div *ngFor="let pos of user.positions" class="exp-item">
                        <div class="dot-line">
                           <div class="dot"></div>
                        </div>
                        <div class="details">
                           <h4>{{ pos.title }}</h4>
                           <p class="company">{{ pos.company }}</p>
                           <p class="period">{{ pos.startDate | date:'MMM yyyy' }} - {{ pos.isCurrent ? 'Present' :
                              (pos.endDate | date:'MMM yyyy') }}</p>
                        </div>
                     </div>
                     <div *ngIf="!user.positions.length" class="empty-item">Professional history not shared.</div>
                  </div>
               </div>

               <div class="glass-card">
                  <h3 class="section-title"><i class="bi bi-mortarboard"></i> Education</h3>
                  <div class="edu-list">
                     <div *ngFor="let edu of user.education" class="edu-item">
                        <div class="edu-icon"><i class="bi bi-book"></i></div>
                        <div class="details">
                           <h4>{{ edu.school }}</h4>
                           <p>{{ edu.degree }} â€¢ {{ edu.fieldOfStudy }}</p>
                           <p class="period">{{ edu.startDate | date:'yyyy' }}</p>
                        </div>
                     </div>
                     <div *ngIf="!user.education.length" class="empty-item">Academic background is private.</div>
                  </div>
               </div>
            </div>

            <!-- Saved Posts Tab -->
            <div *ngSwitchCase="'saved'" class="animate__animated animate__fadeIn">
               <!-- Loading State -->
               <div *ngIf="isSavedLoading" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
               </div>

               <!-- Empty State -->
               <div *ngIf="!isSavedLoading && !savedPosts.length" class="empty-state">
                  <div class="icon-circle"><i class="bi bi-bookmark"></i></div>
                  <h3>No saved items</h3>
                  <p>Posts you save will appear here for easy access.</p>
               </div>

               <!-- Saved Posts List -->
               <article *ngFor="let post of savedPosts"
                  class="post-card glass-card animate__animated animate__fadeInUp">
                  <div class="post-header">
                     <div class="user-info">
                        <img [src]="getAuthorImage(post.author)" class="post-avatar">
                        <div class="meta" (click)="viewPostDetails(post.id, $event)">
                           <h3>{{ getAuthorName(post.author) }}</h3>
                           <p>{{ post.createdAt | date:'longDate' }}</p>
                        </div>
                     </div>
                     <div class="post-actions-btn"><i class="bi bi-three-dots"></i></div>
                  </div>

                  <div class="post-body" (click)="viewPostDetails(post.id, $event)">
                     <h4 *ngIf="post.title" class="post-title">{{ post.title }}</h4>
                     <p class="post-content">{{ post.content }}</p>

                     <!-- Repost Content -->
                     <!-- Repost Content -->
                     <div *ngIf="post.parentPost" class="repost-box">
                        <div class="re-header">
                           <img [src]="getAuthorImage(post.parentPost.author)" class="re-avatar">
                           <strong>{{ getAuthorName(post.parentPost.author) }}</strong>
                        </div>
                        <h5>{{ post.parentPost.title }}</h5>
                        <p>{{ post.parentPost.content }}</p>

                        <!-- Shared Post Media -->
                        <div
                           *ngIf="(post.parentPost.attachments && post.parentPost.attachments.length > 0) || post.parentPost.imageUrl"
                           class="post-media-container mt-3">
                           <img *ngIf="post.parentPost.attachments && post.parentPost.attachments.length > 0"
                              [src]="resolveImageUrl(post.parentPost.attachments[0].url)" class="post-img">
                           <img
                              *ngIf="(!post.parentPost.attachments || post.parentPost.attachments.length === 0) && post.parentPost.imageUrl"
                              [src]="resolveImageUrl(post.parentPost.imageUrl)" class="post-img">
                        </div>
                     </div>

                     <!-- Media -->
                     <div *ngIf="(post.attachments && post.attachments.length > 0) || post.imageUrl"
                        class="post-media-container">
                        <img *ngIf="post.attachments && post.attachments.length > 0"
                           [src]="resolveImageUrl(post.attachments[0].url)" class="post-img">
                        <img *ngIf="(!post.attachments || post.attachments.length === 0) && post.imageUrl"
                           [src]="resolveImageUrl(post.imageUrl)" class="post-img">
                     </div>
                  </div>

                  <!-- PRO INTERACTION BAR (SAVED POSTS) -->
                  <div class="interaction-card"
                     style="border:none; box-shadow:none; padding: 20px 0 0 0; margin: 0; margin-top: 15px; border-top: 1px solid #eee; border-radius: 0;">
                     <button class="btn-action-premium"
                        [class.active-like]="post.userInteraction === InteractionType.Like"
                        (click)="toggleInteraction(post, InteractionType.Like, $event)">
                        <i class="bi"
                           [ngClass]="post.userInteraction === InteractionType.Like ? 'bi-hand-thumbs-up-fill' : 'bi-hand-thumbs-up'"></i>
                        <span>{{ post.stats?.likes || 0 }}</span>
                     </button>

                     <button class="btn-action-premium"
                        [class.active-dislike]="post.userInteraction === InteractionType.Dislike"
                        (click)="toggleInteraction(post, InteractionType.Dislike, $event)">
                        <i class="bi"
                           [ngClass]="post.userInteraction === InteractionType.Dislike ? 'bi-hand-thumbs-down-fill' : 'bi-hand-thumbs-down'"></i>
                        <span>{{ post.stats?.dislikes || 0 }}</span>
                     </button>

                     <button class="btn-action-premium" (click)="toggleComments(post, $event)">
                        <i class="bi bi-chat-left-dots"></i>
                        <span>{{ post.stats?.comments || 0 }}</span>
                     </button>

                     <button class="share-btn-accent" (click)="openShareModal(post, $event)">
                        <i class="bi bi-share-fill"></i> SHARE
                     </button>
                  </div>

                  <!-- PRO COMMENTS SECTION (SAVED) -->
                  <section class="premium-comments animate__animated animate__fadeIn" *ngIf="post.showComments"
                     style="margin-top: 25px;">
                     <div class="comment-entry" (click)="$event.stopPropagation()">
                        <input type="text" placeholder="Share your perspective..." [(ngModel)]="post.newCommentContent"
                           (keydown.enter)="submitComment(post, $event)">
                        <button class="btn-submit-comment" (click)="submitComment(post, $event)"
                           [disabled]="!((post.newCommentContent || '').trim())">
                           <i class="bi bi-arrow-right-short fs-2"></i>
                        </button>
                     </div>
                     <div class="comments-thread" (click)="$event.stopPropagation()">
                        <div class="comment-node" *ngFor="let comment of (post.comments || [])">
                           <div class="comment-card">
                              <div class="comment-content-box">
                                 <div class="header">
                                    <strong>{{ getAuthorName(comment.author) }}</strong>
                                    <time>{{ comment.createdAt | date:'shortTime' }}</time>
                                 </div>
                                 <div class="text">{{ comment.content }}</div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </section>
               </article>
            </div>



         </main>

         <!-- RIGHT SIDEBAR -->
         <aside class="side-col">
            <div class="glass-card mb-4" *ngIf="user.topCommunities && user.topCommunities.length">
               <h4 class="section-title">Communities</h4>
               <div class="community-list">
                  <div *ngFor="let comm of user.topCommunities" class="comm-item">
                     <div class="comm-badge">{{ getInitials(comm.name) }}</div>
                     <div class="comm-info">
                        <h6>{{ comm.name }}</h6>
                        <p>Member</p>
                     </div>
                  </div>
               </div>
            </div>


            <!-- Tags Section -->
            <div class="glass-card mb-4" *ngIf="user.tags">
               <h4 class="section-title"><i class="bi bi-tags"></i> Tags</h4>
               <div class="tags-container" *ngIf="user.tags.length > 0">
                  <span class="badge-tag" *ngFor="let tag of user.tags">{{ tag.name }}</span>
               </div>
               <div class="empty-side-text" *ngIf="user.tags.length === 0">
                  No tags selected.
               </div>
            </div>
         </aside>

      </div>
   </div>
</div>

<!-- SHARE MODAL (Simplified UI) -->
<div class="modal-overlay" *ngIf="showShareModal">
   <div class="modal-card glass-card">
      <h3>Republish Post</h3>
      <textarea [(ngModel)]="shareCommentary" placeholder="What's on your mind?"></textarea>
      <div class="modal-actions">
         <button class="btn-cancel" (click)="closeShareModal()">Cancel</button>
         <button class="btn-confirm" (click)="submitShare()" [disabled]="isSharing">
            <span *ngIf="!isSharing">Repost</span>
            <span *ngIf="isSharing" class="spinner-border spinner-border-sm"></span>
         </button>
      </div>
   </div>
</div>