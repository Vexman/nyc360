<div class="profile-page-container">

   <!-- 1. LOADING STATE -->
   <div *ngIf="isLoading" class="loading-center">
      <div class="loader-diamond"></div>
   </div>

   <div *ngIf="!isLoading && user" class="profile-wrapper">

      <!-- 2. HEADER SECTION -->
      <header class="profile-header-premium animate__animated animate__fadeIn">
         <div class="cover-photo" [style.backgroundImage]="'url(' + resolveCover(user.coverImageUrl) + ')'">
            <div class="cover-overlay"></div>
            <div class="cover-actions" *ngIf="isOwner">
               <input type="file" id="cover-input" hidden (change)="onCoverSelected($event)" accept="image/*">
               <button class="btn-glass" (click)="triggerCoverUpload()">
                  <i class="bi bi-camera"></i> Edit Cover
               </button>
            </div>
            <button class="btn-share-top" (click)="shareProfile()"><i class="bi bi-share"></i></button>
         </div>

         <div class="profile-meta-row">
            <div class="avatar-container">
               <div class="avatar-wrapper">
                  <img [src]="resolveImage(user.imageUrl)" alt="Profile">
                  <div class="avatar-edit" *ngIf="isOwner" (click)="triggerAvatarUpload()">
                     <i class="bi bi-camera-fill"></i>
                     <input type="file" id="avatar-input" hidden (change)="onAvatarSelected($event)" accept="image/*">
                  </div>
               </div>
            </div>

            <div class="identity-block">
               <div class="name-status">
                  <h1>
                     {{ displayName }}
                     <i class="bi bi-patch-check-fill verified-icon" *ngIf="isVerified"
                        title="Verified Professional"></i>
                  </h1>
               </div>
               <p class="headline-text">{{ user.headline || 'Impactful Member @ NYC 360' }}</p>
               <div class="meta-badges">
                  <span class="meta-tag"><i class="bi bi-geo-alt"></i> {{ user.location || 'New York, USA' }}</span>
                  <!-- Show joined date only if we can derive it, or generic -->
                  <span class="meta-tag"><i class="bi bi-calendar3"></i> Active Member</span>
               </div>
            </div>

            <div class="header-actions">
               <button *ngIf="isOwner" class="btn-premium" [routerLink]="['/public/settings']">
                  <i class="bi bi-pencil-square"></i> Edit Profile
               </button>
               <button *ngIf="!isOwner" class="btn-follow">
                  <i class="bi bi-person-plus-fill"></i> Follow
               </button>
            </div>
         </div>
      </header>

      <!-- 3. NAVIGATION -->
      <nav class="sticky-tabs">
         <div class="tabs-container">
            <button class="tab-item" [class.active]="activeTab === 'posts'" (click)="switchTab('posts')">
               <i class="bi bi-grid-3x3"></i> Timeline
            </button>
            <button class="tab-item" [class.active]="activeTab === 'about'" (click)="switchTab('about')">
               <i class="bi bi-person-badge"></i> About
            </button>
            <button class="tab-item" [class.active]="activeTab === 'saved'" (click)="switchTab('saved')"
               *ngIf="isOwner">
               <i class="bi bi-bookmark"></i> Saved
            </button>
         </div>
      </nav>

      <!-- 4. CONTENT GRID -->
      <div class="layout-grid" [ngSwitch]="activeTab">

         <!-- LEFT SIDEBAR -->
         <aside class="side-col">
            <div class="glass-card mb-4" *ngIf="user.bio || isOwner">
               <h4 class="section-title">About Me</h4>
               <p class="bio-text" *ngIf="user.bio">{{ user.bio }}</p>
               <button *ngIf="!user.bio && isOwner" class="btn-add-outline w-100" [routerLink]="['/public/settings']">
                  <i class="bi bi-plus-circle"></i> Add Bio
               </button>
            </div>

            <div class="glass-card mb-4">
               <h4 class="section-title">Contact</h4>
               <ul class="contact-list">
                  <li><i class="bi bi-envelope"></i> <span>{{ user.email }}</span></li>
                  <li *ngIf="user.phoneNumber"><i class="bi bi-phone"></i> <span>{{ user.phoneNumber }}</span></li>
               </ul>
            </div>

            <div class="glass-card mb-4" *ngIf="user.socialLinks.length">
               <h4 class="section-title">Connect</h4>
               <div class="social-links-grid">
                  <a *ngFor="let link of user.socialLinks" [href]="link.url" target="_blank" class="social-icon-btn"
                     [title]="getPlatformName(link.platform)">
                     <i class="bi" [ngClass]="getPlatformIcon(link.platform)"></i>
                  </a>
               </div>
            </div>

            <!-- Stats Card -->
            <div class="glass-card stats-overview" *ngIf="user.stats">
               <div class="stat-item">
                  <span class="val">{{ user.stats.postsCount || 0 }}</span>
                  <span class="lbl">Posts</span>
               </div>
               <div class="stat-item border-x">
                  <span class="val">{{ user.stats.followersCount || 0 }}</span>
                  <span class="lbl">Followers</span>
               </div>
               <div class="stat-item">
                  <span class="val">{{ user.stats.followingCount || 0 }}</span>
                  <span class="lbl">Following</span>
               </div>
            </div>
         </aside>

         <!-- MAIN FEED -->
         <main class="feed-col">

            <!-- Timeline Tab -->
            <div *ngSwitchCase="'posts'" class="animate__animated animate__fadeIn">
               <!-- Create Post Reminder (Owner Only) -->
               <div class="create-post-card glass-card" *ngIf="isOwner">
                  <div class="input-trigger" (click)="viewPostDetails('create', $event)">
                     <img [src]="resolveImage(user.imageUrl)" class="mini-avatar">
                     <span class="placeholder">Share an update with your city...</span>
                  </div>
                  <div class="action-bar">
                     <button (click)="viewPostDetails('create', $event)"><i class="bi bi-image text-success"></i>
                        Media</button>
                     <button (click)="viewPostDetails('create', $event)"><i
                           class="bi bi-calendar-event text-warning"></i> Event</button>
                     <button (click)="viewPostDetails('create', $event)"><i
                           class="bi bi-file-earmark-text text-primary"></i> Article</button>
                  </div>
               </div>

               <!-- Empty Case -->
               <div *ngIf="!user.recentPosts.length" class="empty-state">
                  <div class="icon-circle"><i class="bi bi-journals"></i></div>
                  <h3>No posts yet</h3>
                  <p>Shared updates and insights will appear here.</p>
               </div>

               <!-- Posts List -->
               <article *ngFor="let post of user.recentPosts"
                  class="post-card glass-card animate__animated animate__fadeInUp">
                  <div class="post-header">
                     <div class="user-info">
                        <img [src]="resolveImage(user.imageUrl)" class="post-avatar">
                        <div class="meta" (click)="viewPostDetails(post.id, $event)">
                           <h3>{{ displayName }}</h3>
                           <p>{{ post.createdAt | date:'longDate' }}</p>
                        </div>
                     </div>
                     <div class="post-actions-btn"><i class="bi bi-three-dots"></i></div>
                  </div>

                  <div class="post-body" (click)="viewPostDetails(post.id, $event)">
                     <h4 *ngIf="post.title" class="post-title">{{ post.title }}</h4>
                     <p class="post-content">{{ post.content }}</p>

                     <!-- Repost Content -->
                     <div *ngIf="post.parentPost" class="repost-box">
                        <div class="re-header">
                           <img [src]="getAuthorImage(post.parentPost.author)" class="re-avatar">
                           <strong>{{ getAuthorName(post.parentPost.author) }}</strong>
                        </div>
                        <h5>{{ post.parentPost.title }}</h5>
                        <p>{{ post.parentPost.content }}</p>
                     </div>

                     <!-- Media -->
                     <div *ngIf="post.attachments.length" class="post-media-container">
                        <img [src]="resolveAttachmentUrl(post.attachments[0].url)" class="post-img">
                     </div>
                  </div>

                  <div class="post-footer">
                     <div class="stats">
                        <span (click)="toggleComments(post, $event)"><i class="bi bi-chat-dots"></i> {{
                           post.stats?.comments || 0 }}</span>
                        <span><i class="bi bi-eye"></i> {{ post.stats?.views || 0 }}</span>
                     </div>
                     <div class="interactions">
                        <button class="btn-action" [class.active]="post.userInteraction === InteractionType.Like"
                           (click)="toggleInteraction(post, InteractionType.Like, $event)">
                           <i class="bi"
                              [ngClass]="post.userInteraction === InteractionType.Like ? 'bi-heart-fill' : 'bi-heart'"></i>
                           {{ post.stats?.likes || 0 }}
                        </button>
                        <button class="btn-action" (click)="openShareModal(post, $event)">
                           <i class="bi bi-share"></i>
                        </button>
                     </div>
                  </div>

                  <!-- Comments Section -->
                  <div *ngIf="post.showComments" class="post-comments-section">
                     <div class="comment-input-area">
                        <img [src]="resolveImage(user.imageUrl)" class="mini-avatar">
                        <input type="text" placeholder="Write a comment..." [(ngModel)]="post.newCommentContent"
                           (keyup.enter)="submitComment(post, $event)">
                        <button (click)="submitComment(post, $event)"
                           [disabled]="!((post.newCommentContent || '').trim())"><i
                              class="bi bi-send-fill"></i></button>
                     </div>

                     <div class="comments-list">
                        <div *ngFor="let comment of (post.comments || [])" class="comment-entry">
                           <img [src]="getAuthorImage(comment.author)" class="comment-avatar">

                           <div class="comment-body-wrapper">
                              <!-- Bubble -->
                              <div class="comment-bubble">
                                 <div class="header">
                                    <h6>{{ getAuthorName(comment.author) }}</h6>
                                    <span>{{ comment.createdAt | date:'shortTime' }}</span>
                                 </div>
                                 <p>{{ comment.content }}</p>
                              </div>

                              <!-- Actions (Reply) -->
                              <div class="comment-actions">
                                 <button (click)="openReplyInput(comment)">Reply</button>
                              </div>

                              <!-- Reply Input -->
                              <div class="reply-input-box" *ngIf="activeReplyId === comment.id">
                                 <input #replyIn type="text"
                                    placeholder="Reply to {{ getAuthorName(comment.author) }}..."
                                    (keydown.enter)="submitReply(post, comment, replyIn.value); replyIn.value = ''">
                                 <button (click)="submitReply(post, comment, replyIn.value); replyIn.value = ''">
                                    <i class="bi bi-send-fill"></i>
                                 </button>
                              </div>

                              <!-- Nested Replies -->
                              <div class="nested-replies" *ngIf="comment.replies?.length">
                                 <div *ngFor="let reply of comment.replies" class="reply-item">
                                    <div class="rep-header">
                                       <strong>{{ getAuthorName(reply.author) }}</strong>
                                       <time>{{ reply.createdAt | date:'shortTime' }}</time>
                                    </div>
                                    <p class="rep-text">{{ reply.content }}</p>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </article>
            </div>

            <!-- About Tab -->
            <div *ngSwitchCase="'about'" class="animate__animated animate__fadeIn">
               <div class="glass-card mb-4">
                  <h3 class="section-title"><i class="bi bi-briefcase"></i> Work Experience</h3>
                  <div class="experience-list">
                     <div *ngFor="let pos of user.positions" class="exp-item">
                        <div class="dot-line">
                           <div class="dot"></div>
                        </div>
                        <div class="details">
                           <h4>{{ pos.title }}</h4>
                           <p class="company">{{ pos.company }}</p>
                           <p class="period">{{ pos.startDate | date:'MMM yyyy' }} - {{ pos.isCurrent ? 'Present' :
                              (pos.endDate | date:'MMM yyyy') }}</p>
                        </div>
                     </div>
                     <div *ngIf="!user.positions?.length" class="empty-item">Professional history not shared.</div>
                  </div>
               </div>

               <div class="glass-card">
                  <h3 class="section-title"><i class="bi bi-mortarboard"></i> Education</h3>
                  <div class="edu-list">
                     <div *ngFor="let edu of user.education" class="edu-item">
                        <div class="edu-icon"><i class="bi bi-book"></i></div>
                        <div class="details">
                           <h4>{{ edu.school }}</h4>
                           <p>{{ edu.degree }} â€¢ {{ edu.fieldOfStudy }}</p>
                           <p class="period">{{ edu.startDate | date:'yyyy' }}</p>
                        </div>
                     </div>
                     <div *ngIf="!user.education.length" class="empty-item">Academic background is private.</div>
                  </div>
               </div>
            </div>



         </main>

         <!-- RIGHT SIDEBAR -->
         <aside class="side-col">
            <div class="glass-card mb-4" *ngIf="user.topCommunities && user.topCommunities.length">
               <h4 class="section-title">Communities</h4>
               <div class="community-list">
                  <div *ngFor="let comm of user.topCommunities" class="comm-item">
                     <div class="comm-badge">{{ getInitials(comm.name) }}</div>
                     <div class="comm-info">
                        <h6>{{ comm.name }}</h6>
                        <p>Member</p>
                     </div>
                  </div>
               </div>
            </div>

            <div class="glass-card mb-4" *ngIf="categories && categories.length > 0">
               <h4 class="section-title">Interests</h4>
               <div class="d-flex flex-wrap gap-2">
                  <span *ngFor="let catId of (user.interests || [])" class="badge bg-light text-dark border">
                     {{ getInterestName(catId) }}
                  </span>
                  <span *ngIf="!user.interests?.length" class="text-muted small">No interests listed.</span>
               </div>
            </div>

            <div class="glass-card">
               <h4 class="section-title">Discovery</h4>
               <button class="btn-action-outline w-100 mb-2" (click)="shareProfile()"><i class="bi bi-qr-code"></i> Show
                  QR</button>
               <button class="btn-action-outline w-100" (click)="viewPostDetails('create', $event)"><i
                     class="bi bi-pencil"></i> Write Post</button>
            </div>
         </aside>

      </div>
   </div>
</div>

<!-- SHARE MODAL (Simplified UI) -->
<div class="modal-overlay" *ngIf="showShareModal">
   <div class="modal-card glass-card">
      <h3>Republish Post</h3>
      <textarea [(ngModel)]="shareCommentary" placeholder="What's on your mind?"></textarea>
      <div class="modal-actions">
         <button class="btn-cancel" (click)="closeShareModal()">Cancel</button>
         <button class="btn-confirm" (click)="submitShare()" [disabled]="isSharing">
            <span *ngIf="!isSharing">Repost</span>
            <span *ngIf="isSharing" class="spinner-border spinner-border-sm"></span>
         </button>
      </div>
   </div>
</div>